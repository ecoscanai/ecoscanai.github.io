<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ecoScanAi</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    
    <!-- Custom Styles and Tailwind Configuration -->
    <style>
        /* Inter Font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc; /* Light gray background */
        }

        /* Custom Colors */
        .bg-leaf-green { background-color: #22c55e; }
        .text-leaf-green { color: #22c55e; }
        .border-leaf-green { border-color: #22c55e; }
        .hover\:bg-leaf-green-dark:hover { background-color: #16a34a; }
        .ring-leaf-green:focus {
            --tw-ring-color: #22c55e;
        }

        /* Page transition */
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }

        /* Modal transitions */
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }

        /* Scanner style */
        #scanner-container {
            width: 100%;
            max-width: 500px;
            margin: auto;
            overflow: hidden;
            border-radius: 8px;
            border: 2px dashed #d1d5db; /* gray-300 */
        }
        #qr-reader video {
            width: 100% !important;
            height: auto !important;
        }
        #qr-reader__scan_region {
            border-color: #22c55e !important;
            border-width: 4px !important;
            background: none !important;
        }
        #qr-reader__dashboard_section_csr button {
            background-color: #22c55e !important;
            color: white !important;
        }

        /* Custom scrollbar for alternatives */
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* gray-300 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* gray-400 */
        }
    </style>

    <script>
        // Custom Tailwind Config
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'leaf-green': '#22c55e',
                        'leaf-green-dark': '#16a34a',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 z-50 flex-col items-center justify-center bg-white bg-opacity-80 backdrop-blur-sm hidden">
        <i class="fas fa-leaf fa-spin fa-3x text-leaf-green"></i>
        <p class="mt-4 text-lg font-semibold text-gray-700">Loading...</p>
    </div>

    <!-- Message Bar -->
    <div id="message-bar" class="fixed top-0 left-0 right-0 z-40 p-4 text-center text-white transition-transform -translate-y-full">
        <p id="message-text"></p>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-30 w-full bg-white shadow-md">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Logo -->
                <a href="#" class="flex items-center gap-2" data-nav="home">
                    <i class="fas fa-leaf text-3xl text-leaf-green"></i>
                    <span class="text-2xl font-bold text-gray-800">ecoScanAi</span>
                </a>

                <!-- Desktop Nav -->
                <div class="hidden sm:flex sm:items-center sm:gap-4">
                    <a href="#" class="text-gray-600 hover:text-leaf-green px-3 py-2 rounded-md text-sm font-medium" data-nav="home">Home</a>
                    <a href="#" class="text-gray-600 hover:text-leaf-green px-3 py-2 rounded-md text-sm font-medium" data-nav="about">About Us</a>
                    <a href="#" class="text-gray-600 hover:text-leaf-green px-3 py-2 rounded-md text-sm font-medium" data-nav="scoring">Scoring</a>
                    
                    <!-- Auth Buttons (Desktop) -->
                    <div id="desktop-auth-buttons" class="flex items-center gap-2 ml-2">
                        <!-- Logged out -->
                        <a href="#" class="text-gray-600 hover:text-leaf-green px-3 py-2 rounded-md text-sm font-medium" data-nav="login">Login</a>
                        <a href="#" class="bg-leaf-green text-white px-4 py-2 rounded-full text-sm font-medium hover:bg-leaf-green-dark transition-all" data-nav="register">Create Account</a>
                        
                        <!-- Logged in -->
                        <a href="#" class="text-gray-600 hover:text-leaf-green px-3 py-2 rounded-md text-sm font-medium hidden" data-nav="dashboard">Dashboard</a>
                        <button id="logout-button-desktop" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-full text-sm font-medium hover:bg-gray-300 transition-all hidden">Logout</button>
                    </div>
                </div>

                <!-- Mobile Menu Button -->
                <div class="sm:hidden">
                    <button id="mobile-menu-button" class="inline-flex items-center justify-center p-2 rounded-md text-gray-500 hover:text-leaf-green hover:bg-gray-100">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden sm:hidden bg-white shadow-lg border-t border-gray-100">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <a href="#" class="block text-gray-700 hover:bg-leaf-green hover:text-white px-3 py-2 rounded-md text-base font-medium" data-nav="home">Home</a>
                <a href="#" class="block text-gray-700 hover:bg-leaf-green hover:text-white px-3 py-2 rounded-md text-base font-medium" data-nav="about">About Us</a>
                <a href="#" class="block text-gray-700 hover:bg-leaf-green hover:text-white px-3 py-2 rounded-md text-base font-medium" data-nav="scoring">Scoring</a>
            </div>
            <!-- Auth Buttons (Mobile) -->
            <div id="mobile-auth-buttons" class="px-4 py-3 border-t border-gray-200 space-y-2">
                <!-- Logged out -->
                <a href="#" class="block w-full text-center bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-base font-medium hover:bg-gray-200" data-nav="login">Login</a>
                <a href="#" class="block w-full text-center bg-leaf-green text-white px-4 py-2 rounded-full text-base font-medium hover:bg-leaf-green-dark" data-nav="register">Create Account</a>
                
                <!-- Logged in -->
                <a href="#" class="block w-full text-center text-gray-700 hover:bg-leaf-green hover:text-white px-3 py-2 rounded-md text-base font-medium hidden" data-nav="dashboard">Dashboard</a>
                <button id="logout-button-mobile" class="block w-full text-center bg-gray-100 text-gray-700 px-4 py-2 rounded-full text-base font-medium hover:bg-gray-200 hidden">Logout</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- Home Page -->
        <section id="page-home" class="page">
            <div class="max-w-2xl mx-auto text-center mb-12">
                <h1 class="text-4xl font-extrabold text-gray-900 sm:text-5xl">Make Every Scan Count.</h1>
                <p class="mt-4 text-xl text-gray-600">Instantly check the environmental score of any product. Scan a barcode to begin.</p>
            </div>

            <!-- Search Bar -->
            <div class="max-w-xl mx-auto mb-8 relative">
                <input id="search-input" type="search" placeholder="Search product by name..." class="w-full py-4 pl-12 pr-4 bg-white border border-gray-300 rounded-full text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-leaf-green shadow-sm">
                <div class="absolute left-4 top-1/2 -translate-y-1/2">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
                <!-- Search Results Dropdown -->
                <div id="search-results-container" class="absolute top-full mt-2 w-full bg-white border border-gray-200 rounded-lg shadow-lg z-10 hidden max-h-80 overflow-y-auto">
                    <!-- Results will be injected here -->
                </div>
            </div>

            <!-- Scanner Section -->
            <div class="max-w-xl mx-auto bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-4">Scan Barcode</h2>
                <div id="scanner-container">
                    <div id="qr-reader" class_x="w-full"></div>
                </div>
                <div class="flex items-center justify-center gap-4 mt-4">
                    <button id="start-scanner-btn" class="flex-1 bg-leaf-green text-white px-6 py-3 rounded-full font-semibold hover:bg-leaf-green-dark transition-all">
                        <i class="fas fa-camera mr-2"></i>Start Scanner
                    </button>
                    <button id="stop-scanner-btn" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-full font-semibold hover:bg-gray-300 transition-all hidden">
                        <i class="fas fa-stop mr-2"></i>Stop Scanner
                    </button>
                </div>
                <p id="scanner-status" class="text-center text-gray-500 mt-4 h-6"></p>
            </div>
        </section>

        <!-- About Us Page -->
        <section id="page-about" class="page max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-lg border border-gray-200">
            <h1 class="text-4xl font-bold text-center text-leaf-green mb-6">About ecoScanAi</h1>
            <p class="text-lg text-gray-700 mb-6 leading-relaxed">
                ecoScanAi was born from a shared passion for sustainability and technology. Our mission is to empower consumers to make environmentally conscious decisions with a simple scan of a barcode. We believe that by providing transparent, easy-to-understand data on product sustainability, we can collectively drive change and promote a greener future.
            </p>
            
            <h2 class="text-3xl font-semibold text-gray-800 text-center mb-8">Meet the Team</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-gray-50 border border-gray-200 p-5 rounded-lg text-center">
                    <h3 class="text-xl font-bold text-gray-800">Md. Razibul Hasan Badhon</h3>
                    <p class="text-leaf-green font-medium">Backend & Project Management</p>
                </div>
                <div class="bg-gray-50 border border-gray-200 p-5 rounded-lg text-center">
                    <h3 class="text-xl font-bold text-gray-800">Abdullah Alif</h3>
                    <p class="text-leaf-green font-medium">Backend Developer</p>
                </div>
                <div class="bg-gray-50 border border-gray-200 p-5 rounded-lg text-center">
                    <h3 class="text-xl font-bold text-gray-800">Rifat Hassan</h3>
                    <p class="text-leaf-green font-medium">Frontend Developer</p>
                </div>
                <div class="bg-gray-50 border border-gray-200 p-5 rounded-lg text-center">
                    <h3 class="text-xl font-bold text-gray-800">Lubna Jahan Lipa</h3>
                    <p class="text-leaf-green font-medium">Database Management</p>
                </div>
            </div>
        </section>

        <!-- Scoring Page -->
        <section id="page-scoring" class="page max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-lg border border-gray-200">
            <h1 class="text-4xl font-bold text-center text-leaf-green mb-6">Our Scoring Algorithm</h1>
            <p class="text-lg text-gray-700 mb-6 leading-relaxed">
                To ensure transparency and help you understand our product ratings, we've outlined our scoring algorithm below. The final "Eco-Score" (out of 100) is a weighted average of three key factors: Packaging, Transportation, and Disposal.
            </p>
            
            <div class="text-center bg-gray-50 border border-gray-200 p-4 rounded-lg mb-8">
                <p class="text-xl font-bold text-gray-800">
                    Final Score = (Packaging * 0.35) + (Transportation * 0.30) + (Disposal * 0.35)
                </p>
            </div>
            
            <div class="space-y-8">
                <!-- Score Details will be rendered here by JS -->
                <div id="scoring-details-container"></div>
            </div>
            
            <p class="text-sm text-gray-500 mt-8 text-center">
                Disclaimer: This scoring model is based on our internal logic and publicly available data. It is intended for informational purposes to guide consumers and may not capture every nuance of a product's lifecycle.
            </p>
        </section>

        <!-- Login Page -->
        <section id="page-login" class="page">
            <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg border border-gray-200">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Log In</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700">Email address</label>
                        <input id="login-email" name="email" type="email" autocomplete="email" required
                            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-leaf-green focus:border-leaf-green">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input id="login-password" name="password" type="password" autocomplete="current-password" required
                            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-leaf-green focus:border-leaf-green">
                    </div>
                    <button type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-full shadow-sm text-base font-medium text-white bg-leaf-green hover:bg-leaf-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-leaf-green">
                        Sign In
                    </button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-600">
                    Don't have an account?
                    <a href="#" id="showRegisterLink" class="font-medium text-leaf-green hover:underline" data-nav="register">
                        Sign up
                    </a>
                </p>
            </div>
        </section>

        <!-- Register Page -->
        <section id="page-register" class="page">
            <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg border border-gray-200">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Create Account</h2>
                <form id="register-form" class="space-y-4">
                    <div>
                        <label for="register-name" class="block text-sm font-medium text-gray-700">Name</label>
                        <input id="register-name" name="name" type="text" required
                            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-leaf-green focus:border-leaf-green">
                    </div>
                    <div>
                        <label for="register-email" class="block text-sm font-medium text-gray-700">Email address</label>
                        <input id="register-email" name="email" type="email" autocomplete="email" required
                            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-leaf-green focus:border-leaf-green">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input id="register-password" name="password" type="password" autocomplete="new-password" required
                            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-leaf-green focus:border-leaf-green">
                        <p class="mt-1 text-xs text-gray-500">Must be at least 8 characters long.</p>
                    </div>
                    <button type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-full shadow-sm text-base font-medium text-white bg-leaf-green hover:bg-leaf-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-leaf-green">
                        Create Account
                    </button>
                </form>
                <p class="mt-6 text-center text-sm text-gray-600">
                    Already have an account?
                    <a href="#" id="showLoginLink" class="font-medium text-leaf-green hover:underline" data-nav="login">
                        Log in here
                    </a>
                </p>
            </div>
        </section>

        <!-- Dashboard Page -->
        <section id="page-dashboard" class="page">
            <h1 class="text-4xl font-bold text-gray-900 mb-2">
                Welcome back, <span id="user-name" class="text-leaf-green">User</span>!
            </h1>
            <p class="text-lg text-gray-600 mb-8">Here's your eco-dashboard.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Profile Info -->
                <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                    <h2 class="text-2xl font-semibold text-leaf-green mb-4">Profile Info</h2>
                    <div class="space-y-3">
                        <div class="flex justify-between flex-wrap">
                            <span class="text-gray-500">Name:</span>
                            <span id="dash-user-name" class="text-gray-800 font-medium text-right"></span>
                        </div>
                        <div class="flex justify-between flex-wrap">
                            <span class="text-gray-500">Email:</span>
                            <span id="dash-user-email" class="text-gray-800 font-medium text-right break-all"></span>
                        </div>
                        <div class="flex justify-between flex-wrap">
                            <span class="text-gray-500">Member Since:</span>
                            <span id="dash-user-created" class="text-gray-800 font-medium text-right"></span>
                        </div>
                    </div>
                </div>
                
                <!-- Score/Points -->
                <div class="bg-white p-6 rounded-lg shadow-lg border border-gray-200 flex flex-col items-center justify-center text-center">
                    <h2 class="text-2xl font-semibold text-leaf-green mb-2">Your Eco-Points</h2>
                    <p id="dash-user-points" class="text-6xl font-bold text-gray-800">0</p>
                    <p class="text-gray-500 mt-2">
                        Keep scanning and requesting products to earn more!
                    </p>
                </div>
            </div>
            
            <!-- Request Product Section -->
            <div class="mt-8 bg-white p-6 rounded-lg shadow-lg border border-gray-200">
                <h2 class="text-2xl font-semibold text-leaf-green mb-4">Can't Find a Product?</h2>
                <p class="text-gray-700 mb-5">
                    Help our database grow and earn points! If you know of a product we're missing, you can submit it here.
                </p>
                <button id="dash-request-product-btn"
                    class="w-full sm:w-auto bg-leaf-green text-white font-bold py-3 px-6 rounded-full transition-all hover:bg-leaf-green-dark">
                    Request a New Product
                </button>
            </div>
        </section>

        <!-- Request Product Page -->
        <section id="page-request-product" class="page">
            <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg border border-gray-200">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Request New Product</h2>
                <form id="request-product-form" class="space-y-4">
                    <div>
                        <label for="request-barcode" class="block text-sm font-medium text-gray-700">Barcode</label>
                        <input id="request-barcode" name="barcode" type="text" required
                            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-leaf-green focus:border-leaf-green">
                    </div>
                    <div>
                        <label for="request-name" class="block text-sm font-medium text-gray-700">Product Name</label>
                        <input id="request-name" name="name" type="text" required
                            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-leaf-green focus:border-leaf-green">
                    </div>
                    <div>
                        <label for="request-brand" class="block text-sm font-medium text-gray-700">Brand Name</label>
                        <input id="request-brand" name="brandname" type="text"
                            class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-leaf-green focus:border-leaf-green">
                    </div>
                    <div>
                        <label for="request-image" class="block text-sm font-medium text-gray-700">Product Image</label>
                        <input id="request-image" name="productImage" type="file" accept="image/*" required
                            class="mt-1 block w-full text-sm text-gray-500
                            file:mr-4 file:py-2 file:px-4
                            file:rounded-full file:border-0
                            file:text-sm file:font-semibold
                            file:bg-leaf-green file:text-white
                            hover:file:bg-leaf-green-dark">
                    </div>
                    <button type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-full shadow-sm text-base font-medium text-white bg-leaf-green hover:bg-leaf-green-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-leaf-green">
                        Submit Request
                    </button>
                </form>
            </div>
        </section>
    </main>

    <!-- Product Modal -->
    <div id="product-modal" class="modal fixed inset-0 z-40 flex items-center justify-center bg-black bg-opacity-60 backdrop-blur-sm p-4 hidden" role="dialog" aria-modal="true">
        <div class="modal-content relative w-full max-w-3xl max-h-[90vh] bg-white rounded-lg shadow-xl overflow-y-auto transform scale-95">
            
            <!-- Modal Header -->
            <div class="flex items-start justify-between p-5 border-b border-gray-200 sticky top-0 bg-white z-10">
                <h3 class="text-2xl font-bold text-gray-800">Product Details</h3>
                <button id="product-modal-close" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-6">
                <!-- Loader -->
                <div id="product-modal-loader" class="text-center py-16 hidden">
                    <i class="fas fa-leaf fa-spin fa-3x text-leaf-green"></i>
                    <p class="mt-4 text-lg font-semibold text-gray-700">Fetching product...</p>
                </div>
                
                <!-- Error -->
                <div id="product-modal-error" class="text-center py-16 hidden">
                    <i class="fas fa-exclamation-triangle fa-3x text-red-500"></i>
                    <p id="product-modal-error-text" class="mt-4 text-lg font-semibold text-red-600">Product not found.</p>
                    <button id="product-modal-request-btn"
                        class="mt-6 bg-leaf-green text-white font-bold py-3 px-6 rounded-full transition-all hover:bg-leaf-green-dark">
                        Request This Product
                    </button>
                </div>

                <!-- Content -->
                <div id="product-modal-content" class="hidden">
                    <!-- Main Product Info -->
                    <div class="flex flex-col md:flex-row gap-6">
                        <img id="product-img" src="https://placehold.co/400x400/eeeeee/cccccc?text=No+Image" alt="Product Image" class="w-full md:w-1/3 h-64 object-cover rounded-lg border border-gray-200">
                        <div class="flex-1">
                            <h2 id="product-name" class="text-3xl font-bold text-gray-900">Product Name</h2>
                            <p id="product-brand" class="text-lg text-gray-500 mb-4">Brand</p>
                            <p class="text-sm text-gray-500 mb-4">Barcode: <span id="product-barcode"></span></p>
                            
                            <!-- Score -->
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                                <h4 class="text-sm font-medium text-gray-500 mb-1">Eco-Score</h4>
                                <div class="flex items-baseline gap-2">
                                    <span id="product-score" class="text-4xl font-extrabold text-leaf-green">0 / 100</span>
                                    <span id="product-score-rating" class="text-lg font-semibold text-gray-700">Not Rated</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Score Breakdown (Charts) -->
                    <div class="mt-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Score Breakdown</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Packaging -->
                            <div class="text-center">
                                <canvas id="packaging-chart" width="120" height="120"></canvas>
                                <h4 id="detail-packaging" class="text-base font-semibold text-gray-700 mt-2">Packaging</h4>
                            </div>
                            <!-- Transport -->
                            <div class="text-center">
                                <canvas id="transport-chart" width="120" height="120"></canvas>
                                <h4 id="detail-transport" class="text-base font-semibold text-gray-700 mt-2">Transport</h4>
                            </div>
                            <!-- Disposal -->
                            <div class="text-center">
                                <canvas id="disposal-chart" width="120" height="120"></canvas>
                                <h4 id="detail-disposal" class="text-base font-semibold text-gray-700 mt-2">Disposal</h4>
                            </div>
                        </div>
                    </div>

                    <!-- Alternatives -->
                    <div id="product-alternatives-container" class="mt-10 hidden">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Greener Alternatives</h3>
                        <div id="product-alternatives-list" class="flex gap-4 overflow-x-auto pb-4 custom-scrollbar">
                            <!-- Alternative cards injected by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Chart.js for modal charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

    <!-- Main Application Logic -->
    <script>
        // --- Configuration ---
        // !!! IMPORTANT: Replace this with your live backend URL
        const API_BASE_URL = "https://your-live-backend-url.com";

        document.addEventListener('DOMContentLoaded', () => {
            
            // --- State ---
            let html5QrCode = null;
            let isScannerRunning = false;
            let searchTimeout = null;
            let state = {
                loggedInUser: null, // { name, email, points, created_at, ... }
                authToken: null,
            };

            // --- Element Selectors ---
            const $ = document.querySelector.bind(document);
            const $$ = document.querySelectorAll.bind(document);

            // Pages
            const pages = $$('.page');
            const pageHome = $('#page-home');
            const pageAbout = $('#page-about');
            const pageScoring = $('#page-scoring');
            const pageLogin = $('#page-login');
            const pageRegister = $('#page-register');
            const pageDashboard = $('#page-dashboard');
            const pageRequestProduct = $('#page-request-product');

            // Header & Nav
            const mobileMenuButton = $('#mobile-menu-button');
            const mobileMenu = $('#mobile-menu');
            const desktopAuthButtons = $('#desktop-auth-buttons');
            const mobileAuthButtons = $('#mobile-auth-buttons');

            // Scanner
            const startScannerBtn = $('#start-scanner-btn');
            const stopScannerBtn = $('#stop-scanner-btn');
            const scannerStatus = $('#scanner-status');

            // Search
            const searchInput = $('#search-input');
            const searchResultsContainer = $('#search-results-container');
            
            // Modals
            const productModal = $('#product-modal');
            const productModalClose = $('#product-modal-close');
            const productModalLoader = $('#product-modal-loader');
            const productModalError = $('#product-modal-error');
            const productModalErrorText = $('#product-modal-error-text');
            const productModalRequestBtn = $('#product-modal-request-btn');
            const productModalContent = $('#product-modal-content');

            // Product Modal Content
            const productModalName = $('#product-name');
            const productModalBrand = $('#product-brand');
            const productModalBarcode = $('#product-barcode');
            const productModalImage = $('#product-img');
            const productModalScore = $('#product-score');
            const productModalScoreRating = $('#product-score-rating');
            const productAlternativesContainer = $('#product-alternatives-container');
            const productAlternativesList = $('#product-alternatives-list');

            // Forms
            const loginForm = $('#login-form');
            const registerForm = $('#register-form');
            const requestProductForm = $('#request-product-form');

            // Dashboard
            const userNameEl = $('#user-name');
            const dashUserName = $('#dash-user-name');
            const dashUserEmail = $('#dash-user-email');
            const dashUserCreated = $('#dash-user-created');
            const dashUserPoints = $('#dash-user-points');
            const dashRequestProductBtn = $('#dash-request-product-btn');

            // Misc
            const loadingOverlay = $('#loading-overlay');
            const messageBar = $('#message-bar');
            const messageText = $('#message-text');

            // --- UI & State Functions ---

            function showLoading(isLoading) {
                loadingOverlay.classList.toggle('hidden', !isLoading);
                loadingOverlay.classList.toggle('flex', isLoading);
            }

            function showMessage(message, isError = false) {
                messageText.textContent = message;
                messageBar.className = 'fixed top-0 left-0 right-0 z-40 p-4 text-center text-white transition-transform'; // Reset classes
                if (isError) {
                    messageBar.classList.add('bg-red-500');
                } else {
                    messageBar.classList.add('bg-leaf-green');
                }
                messageBar.style.transform = 'translateY(0)';
                
                setTimeout(() => {
                    messageBar.style.transform = 'translateY(-100%)';
                }, 3000);
            }

            function navigate(pageId) {
                pages.forEach(page => {
                    page.classList.remove('active');
                });
                $(`#page-${pageId}`).classList.add('active');
                window.scrollTo(0, 0); // Scroll to top on page change
                mobileMenu.classList.add('hidden'); // Close mobile menu on nav
            }

            function showModal(modalElement) {
                modalElement.classList.remove('hidden');
                setTimeout(() => {
                    modalElement.querySelector('.modal-content').classList.remove('scale-95');
                }, 10); // Start transition
            }

            function hideModal(modalElement) {
                modalElement.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => {
                    modalElement.classList.add('hidden');
                }, 300); // Wait for transition
            }

            function updateHeader() {
                const loggedIn = !!state.authToken;

                // Desktop
                desktopAuthButtons.querySelector('[data-nav="login"]').classList.toggle('hidden', loggedIn);
                desktopAuthButtons.querySelector('[data-nav="register"]').classList.toggle('hidden', loggedIn);
                desktopAuthButtons.querySelector('[data-nav="dashboard"]').classList.toggle('hidden', !loggedIn);
                desktopAuthButtons.querySelector('#logout-button-desktop').classList.toggle('hidden', !loggedIn);

                // Mobile
                mobileAuthButtons.querySelector('[data-nav="login"]').classList.toggle('hidden', loggedIn);
                mobileAuthButtons.querySelector('[data-nav="register"]').classList.toggle('hidden', loggedIn);
                mobileAuthButtons.querySelector('[data-nav="dashboard"]').classList.toggle('hidden', !loggedIn);
                mobileAuthButtons.querySelector('#logout-button-mobile').classList.toggle('hidden', !loggedIn);
            }

            function saveAuth(token, user) {
                state.authToken = token;
                state.loggedInUser = user;
                localStorage.setItem('authToken', token);
                localStorage.setItem('loggedInUser', JSON.stringify(user));
                updateHeader();
                updateDashboard();
            }

            function clearAuth() {
                state.authToken = null;
                state.loggedInUser = null;
                localStorage.removeItem('authToken');
                localStorage.removeItem('loggedInUser');
                updateHeader();
                navigate('home');
            }

            function updateDashboard() {
                if (state.loggedInUser) {
                    userNameEl.textContent = state.loggedInUser.name;
                    dashUserName.textContent = state.loggedInUser.name;
                    dashUserEmail.textContent = state.loggedInUser.email;
                    dashUserPoints.textContent = state.loggedInUser.points;
                    dashUserCreated.textContent = new Date(state.loggedInUser.created_at).toLocaleDateString();
                }
            }

            // --- API Functions ---

            async function apiRequest(endpoint, method = 'GET', body = null, token = null) {
                const headers = {};
                const options = {
                    method,
                    headers,
                };

                if (body) {
                    if (body instanceof FormData) {
                        // Don't set Content-Type, browser will do it
                    } else {
                        headers['Content-Type'] = 'application/json';
                        options.body = JSON.stringify(body);
                    }
                }

                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                showLoading(true);
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                    
                    if (response.status === 204) {
                        return null; // For successful logout
                    }

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'An unknown error occurred');
                    }
                    
                    return data;
                } catch (error) {
                    console.error('API Error:', error);
                    showMessage(error.message, true);
                    throw error; // Re-throw to be caught by callers
                } finally {
                    showLoading(false);
                }
            }

            // --- Scanner Functions ---

            function onScanSuccess(decodedText, decodedResult) {
                if (isScannerRunning) {
                    stopScanner();
                    scannerStatus.textContent = `Success! Found: ${decodedText}`;
                    showMessage(`Scan successful: ${decodedText}`);
                    // Fetch product details and show modal
                    fetchProductByBarcode(decodedText);
                }
            }

            function onScanFailure(error) {
                // console.warn(`Code scan error = ${error}`);
            }

            function startScanner() {
                if (isScannerRunning) return;

                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("qr-reader");
                }
                
                html5QrCode.start(
                    { facingMode: "environment" }, // Default to back camera
                    {
                        fps: 10,
                        qrbox: { width: 250, height: 150 }
                    },
                    onScanSuccess,
                    onScanFailure
                ).then(() => {
                    isScannerRunning = true;
                    startScannerBtn.classList.add('hidden');
                    stopScannerBtn.classList.remove('hidden');
                    scannerStatus.textContent = "Scanner is active...";
                }).catch(err => {
                    console.error("Failed to start scanner:", err);
                    scannerStatus.textContent = "Failed to start camera.";
                    showMessage("Could not access camera. Please check permissions.", true);
                });
            }

            function stopScanner() {
                if (!isScannerRunning || !html5QrCode) return;

                html5QrCode.stop().then(() => {
                    isScannerRunning = false;
                    startScannerBtn.classList.remove('hidden');
                    stopScannerBtn.classList.add('hidden');
                    scannerStatus.textContent = "Scanner stopped.";
                }).catch(err => {
                    console.error("Failed to stop scanner:", err);
                    // Force state update even if stop fails
                    isScannerRunning = false;
                    startScannerBtn.classList.remove('hidden');
                    stopScannerBtn.classList.add('hidden');
                });
            }

            // --- Product & Search Functions ---

            // *** THIS FUNCTION IS NOW UPDATED ***
            async function fetchProductByBarcode(barcode) {
                if (isScannerRunning) {
                    stopScanner();
                    scannerStatus.textContent = "Scanner stopped. Processing...";
                }
                
                try {
                    // This 'data' object is the new ProductResponse from your Go backend
                    // It contains: { product: {...}, score: 123, score_rating: "...", alternatives: [...] }
                    const data = await apiRequest(`/api/v1/products/barcode/${barcode}`);
                    
                    // *** THIS IS THE FIX ***
                    // Pass the *entire* 'data' object to the render function
                    renderProductModal(data); 

                    scannerStatus.textContent = `Found: ${data.product.name}`;
                } catch (error) {
                    console.error("Error fetching product:", error);
                    scannerStatus.textContent = "Product not found.";
                    // Show error in the modal
                    showModal(productModal);
                    productModalContent.classList.add('hidden');
                    productModalLoader.classList.add('hidden');
                    productModalError.classList.remove('hidden');
                    productModalErrorText.textContent = `Product with barcode ${barcode} not found.`;
                    
                    // Pre-fill request form if logged in
                    if (state.loggedInUser) {
                        productModalRequestBtn.classList.remove('hidden');
                        productModalRequestBtn.onclick = () => {
                            hideModal(productModal);
                            navigate('request-product');
                            $('#request-barcode').value = barcode;
                        };
                    } else {
                        productModalRequestBtn.classList.add('hidden');
                    }
                }
            }

            async function searchProducts(query) {
                if (query.length < 3) {
                    searchResultsContainer.classList.add('hidden');
                    return;
                }
                
                try {
                    const results = await apiRequest(`/api/v1/products/search?q=${encodeURIComponent(query)}`);
                    searchResultsContainer.innerHTML = ''; // Clear old results
                    
                    if (results && results.length > 0) {
                        results.forEach(product => {
                            const resultEl = document.createElement('div');
                            resultEl.className = 'p-3 hover:bg-gray-100 cursor-pointer flex items-center gap-3';
                            resultEl.dataset.barcode = product.barcode;
                            resultEl.innerHTML = `
                                <img src="${product.image_url || 'https://placehold.co/100x100/eeeeee/cccccc?text=No+Image'}" alt="${product.name}" class="w-12 h-12 object-cover rounded-md flex-shrink-0">
                                <div class="overflow-hidden">
                                    <h4 class="text-sm font-semibold text-gray-800 truncate">${product.name}</h4>
                                    <p class="text-xs text-gray-500 truncate">${product.brand_name}</p>
                                </div>
                                <span class="ml-auto text-sm font-bold text-leaf-green">${product.score}</span>
                            `;
                            resultEl.addEventListener('click', () => {
                                searchResultsContainer.classList.add('hidden');
                                searchInput.value = '';
                                fetchProductByBarcode(product.barcode);
                            });
                            searchResultsContainer.appendChild(resultEl);
                        });
                    } else {
                        searchResultsContainer.innerHTML = '<p class="p-3 text-sm text-gray-500">No products found.</p>';
                    }
                    searchResultsContainer.classList.remove('hidden');

                } catch (error) {
                    console.error("Search error:", error);
                    searchResultsContainer.classList.add('hidden');
                }
            }
            
            // *** THIS FUNCTION IS NOW UPDATED ***
            function renderProductModal(data) {
                // 1. Unpack data at the top
                const product = data.product;
                const alternatives = data.alternatives;

                showModal(productModal); // Show the modal
                productModalLoader.classList.add('hidden');
                productModalError.classList.add('hidden');
                productModalContent.classList.remove('hidden');
                
                // 2. Corrected check (must be AFTER product is defined)
                if (!product) {
                    console.error("renderProductModal called with no product");
                    return;
                }

                // 3. Get text names for breakdown
                const packName = product.packaging_material.replace(/_/g, ' ');
                const transName = product.manufacturing_location;
                const dispName = product.disposal_method.replace(/_/g, ' ');
                
                // 4. Update charts with simple text (individual scores are not in the new API)
                updateChart(packagingChart, 'Packaging', 0, packName);
                updateChart(transportChart, 'Transport', 0, transName);
                updateChart(disposalChart, 'Disposal', 0, dispName);

                // 5. Main product info
                productModalImage.src = product.image_url || 'https://placehold.co/400x400/eeeeee/cccccc?text=No+Image';
                productModalName.textContent = product.name;
                productModalBrand.textContent = product.brand_name;
                productModalBarcode.textContent = product.barcode;
                
                // 6. *** THE FIX ***
                //    Use the top-level 'data.score' and 'data.score_rating'
                productModalScore.textContent = `${data.score} / 100`;
                productModalScoreRating.textContent = data.score_rating;

                // 7. Render alternatives (This logic is from your file and is correct)
                productAlternativesList.innerHTML = ''; // Clear previous

                if (alternatives && alternatives.length > 0) {
                    alternatives.forEach(alt => {
                        const altCard = `
                            <div class="flex-shrink-0 w-48 bg-gray-50 border border-gray-200 rounded-lg shadow-sm p-3 cursor-pointer hover:shadow-md" data-barcode="${alt.barcode}">
                                <img src="${alt.image_url || 'https://placehold.co/200x200/eeeeee/cccccc?text=No+Image'}" alt="${alt.name}" class="w-full h-24 object-cover rounded-md mb-2">
                                <h4 class="font-semibold text-sm truncate">${alt.name}</h4>
                                <p class="text-xs text-gray-500 truncate mb-2">${alt.brand_name}</p>
                                <div class="flex items-center justify-between">
                                    <span class="font-bold text-lg text-leaf-green">${alt.score}</span>
                                    <span class="text-xs font-medium ${alt.score > product.score ? 'text-green-500' : 'text-red-500'}">
                                        ${alt.score > product.score ? '+' : ''}${alt.score - product.score}
                                    </span>
                                </div>
                            </div>
                        `;
                        productAlternativesList.innerHTML += altCard;
                    });
                    productAlternativesContainer.classList.remove('hidden');
                } else {
                    productAlternativesContainer.classList.add('hidden');
                }
                
                // Add click listeners to alternatives (This logic is from your file)
                productAlternativesList.querySelectorAll('[data-barcode]').forEach(card => {
                    card.addEventListener('click', () => {
                        fetchProductByBarcode(card.dataset.barcode, false); // Fetch new product
                    });
                });
            }


            // --- Charting ---
            let packagingChart, transportChart, disposalChart;

            function createDoughnutChart(ctx, label, score) {
                return new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: [label, ''],
                        datasets: [{
                            data: [score, 100 - score],
                            backgroundColor: ['#22c55e', '#e5e7eb'], // green, gray-200
                            borderWidth: 0,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        cutout: '75%',
                        plugins: {
                            legend: { display: false },
                            tooltip: { enabled: false },
                        },
                        animation: {
                            animateRotate: true,
                            animateScale: true
                        }
                    }
                });
            }

            function updateChart(chart, label, score, textLabel) {
                // We set the score to 0 because the new API doesn't provide it
                // but we keep the text label.
                let displayScore = 0; 
                let scoreColor = '#e5e7eb'; // Default to gray

                // This text label is the important part
                const chartElement = chart.canvas.parentElement;
                chartElement.querySelector('h4').textContent = textLabel;

                chart.data.labels = [label, ''];
                chart.data.datasets[0].data = [displayScore, 100 - displayScore];
                chart.data.datasets[0].backgroundColor = [scoreColor, '#e5e7eb'];
                chart.update();
            }

            // Initialize charts
            packagingChart = createDoughnutChart($('#packaging-chart').getContext('2d'), 'Packaging', 0);
            transportChart = createDoughnutChart($('#transport-chart').getContext('2d'), 'Transport', 0);
            disposalChart = createDoughnutChart($('#disposal-chart').getContext('2d'), 'Disposal', 0);


            // --- Scoring Page Logic ---
            // (These are just for the static 'Scoring' page, not the modal)
            const scoreCriteria = {
                Packaging: [
                    { name: "None, Compostable Paper", score: 100 },
                    { name: "Glass, Paper, Cardboard", score: 80 },
                    { name: "Aluminum, Recyclable Plastic", score: 60 },
                    { name: "Unknown / Other", score: 40 },
                    { name: "Plastic, Mixed Materials", score: 20 },
                ],
                Transportation: [
                    { name: "Local, Regional", score: 95 },
                    { name: "National", score: 70 },
                    { name: "Unknown / Other", score: 50 },
                    { name: "International", score: 30 },
                ],
                Disposal: [
                    { name: "Compostable, Reusable", score: 100 },
                    { name: "Recyclable", score: 85 },
                    { name: "Minimal Impact", score: 70 },
                    { name: "Unknown / Other", score: 40 },
                    { name: "Landfill", score: 10 },
                ]
            };
            
            function renderScoringPage() {
                const container = $('#scoring-details-container');
                container.innerHTML = '';
                for (const [title, categories] of Object.entries(scoreCriteria)) {
                    let categoryHtml = categories.map(cat => `
                        <li class="flex justify-between items-center py-3">
                            <span class="text-gray-600">${cat.name}</span>
                            <span class="font-bold text-lg text-leaf-green">${cat.score} pts</span>
                        </li>
                    `).join('');

                    container.innerHTML += `
                        <div>
                            <h2 class="text-2xl font-semibold text-gray-800 mb-3">${title}</h2>
                            <ul class="divide-y divide-gray-200 bg-gray-50 border border-gray-200 rounded-lg px-4">
                                ${categoryHtml}
                            </ul>
                        </div>
                    `;
                }
            }
            renderScoringPage();

            // --- Event Listeners ---

            // Navigation
            document.body.addEventListener('click', (e) => {
                const navLink = e.target.closest('[data-nav]');
                if (navLink) {
                    e.preventDefault();
                    const pageId = navLink.dataset.nav;
                    navigate(pageId);
                }
            });

            // Mobile Menu
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });

            // Auth Forms
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(loginForm);
                const data = Object.fromEntries(formData.entries());
                
                try {
                    const response = await apiRequest('/api/v1/auth/login', 'POST', data);
                    saveAuth(response.access_token, response.user);
                    showMessage('Login successful!');
                    navigate('dashboard');
                } catch (error) {
                    // apiRequest already shows message
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(registerForm);
                const data = Object.fromEntries(formData.entries());

                if (data.password.length < 8) {
                    showMessage("Password must be at least 8 characters long.", true);
                    return;
                }
                
                try {
                    await apiRequest('/api/v1/auth/register', 'POST', data);
                    showMessage('Registration successful! Please log in.');
                    navigate('login');
                } catch (error) {
                    // apiRequest already shows message
                }
            });
            
            // Logout
            $('#logout-button-desktop').addEventListener('click', clearAuth);
            $('#logout-button-mobile').addEventListener('click', clearAuth);

            // Scanner Buttons
            startScannerBtn.addEventListener('click', startScanner);
            stopScannerBtn.addEventListener('click', stopScanner);

            // Product Modal
            productModalClose.addEventListener('click', () => hideModal(productModal));
            productModal.addEventListener('click', (e) => {
                if (e.target === productModal) { // Click on overlay
                    hideModal(productModal);
                }
            });

            // Dashboard Request Button
            dashRequestProductBtn.addEventListener('click', () => {
                $('#request-barcode').value = ''; // Clear barcode
                navigate('request-product');
            });

            // Request Product Form
            requestProductForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(requestProductForm);
                
                if (!state.authToken) {
                    showMessage("You must be logged in to request a product.", true);
                    navigate('login');
                    return;
                }

                try {
                    const response = await apiRequest('/api/v1/products/request', 'POST', formData, state.authToken);
                    showMessage('Product request submitted! You earned 10 points.');
                    
                    // Update user points in state
                    const updatedUser = { ...state.loggedInUser, points: state.loggedInUser.points + 10 };
                    saveAuth(state.authToken, updatedUser);
                    
                    navigate('dashboard');
                    requestProductForm.reset();
                } catch (error) {
                    // apiRequest shows message
                }
            });

            // Search
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchProducts(searchInput.value);
                }, 300); // Debounce
            });
            // Hide search results when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchResultsContainer.contains(e.target) && e.target !== searchInput) {
                    searchResultsContainer.classList.add('hidden');
                }
            });

            // === INITIALIZATION ===
            function initApp() {
                // Check for saved auth token
                const token = localStorage.getItem('authToken');
                const user = localStorage.getItem('loggedInUser');
                
                if (token && user) {
                    try {
                        const parsedUser = JSON.parse(user);
                        // Here you might want to validate the token against a /me endpoint
                        // For now, we'll trust the stored data
                        saveAuth(token, parsedUser);
                    } catch (e) {
                        clearAuth();
                    }
                } else {
                    clearAuth(); // Ensure header is in logged-out state
                }
                
                updateHeader();
                navigate('home'); // Start on the home page
            }
            
            initApp();
        });
    </script>
</body>
</html>

